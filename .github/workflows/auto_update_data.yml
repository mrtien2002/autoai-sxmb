name: Auto Update Data Master

on:
  schedule:
    - cron: "30 11 * * *"   # chạy lúc 18h30 giờ Việt Nam
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: pip install requests pandas beautifulsoup4 lxml

      - name: Fetch latest XSMB result and prepend to data_master.csv
        run: |
          import pandas as pd, requests, re
          from datetime import datetime
          from bs4 import BeautifulSoup

          # Lấy dữ liệu từ ketqua.net
          url = "https://ketqua.net/xo-so-mien-bac"
          html = requests.get(url, timeout=20).text
          soup = BeautifulSoup(html, "lxml")
          day = soup.select_one("h2.title-xsmb").get_text(strip=True)
          day = re.search(r"(\d{1,2}/\d{1,2}/\d{4})", day).group(1)
          prizes = [x.get_text(strip=True) for x in soup.select("table.bkqmienbac td span")]
          new_row = {"Ngày": day, "Kết quả": ",".join(prizes)}

          df_new = pd.DataFrame([new_row])
          df_old = pd.read_csv("data/data_master.csv")

          # Kiểm tra nếu ngày đã có rồi thì bỏ qua
          if str(df_old.iloc[0,0]) == day:
              print(f"⚠️ Dữ liệu {day} đã có, không thêm mới.")
          else:
              df_final = pd.concat([df_new, df_old], ignore_index=True)
              df_final.to_csv("data/data_master.csv", index=False)
              print(f"✅ Đã thêm dữ liệu mới: {day} lên đầu file data_master.csv")

      - name: Commit and push updates
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/data_master.csv
          git commit -m "Auto update data_master.csv"
          git push
