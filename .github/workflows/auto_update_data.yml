name: Auto Update Data Master (XSMB)

on:
  schedule:
    - cron: "30 11 * * *"   # cháº¡y lÃºc 18h30 giá» Viá»‡t Nam (UTC+7)
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install requests pandas beautifulsoup4 lxml

      - name: ğŸ”„ Fetch latest XSMB result and prepend to data_master.csv
        run: |
          python <<'PY'
          import pandas as pd, requests, re, os
          from bs4 import BeautifulSoup

          url = "https://ketqua.net/xo-so-mien-bac"
          html = requests.get(url, timeout=20).text
          soup = BeautifulSoup(html, "lxml")

          # Láº¥y ngÃ y quay
          title = soup.select_one("h2.title-xsmb").get_text(strip=True)
          day = re.search(r"(\d{1,2}/\d{1,2}/\d{4})", title).group(1)

          # Láº¥y toÃ n bá»™ cÃ¡c sá»‘ 2 chá»¯ cuá»‘i (00â€“99)
          numbers = [x.get_text(strip=True)[-2:] for x in soup.select("table.bkqmienbac td span")]
          if not numbers:
              raise Exception("âŒ KhÃ´ng láº¥y Ä‘Æ°á»£c dá»¯ liá»‡u XSMB tá»« trang ketqua.net")

          new_row = {"NgÃ y": day, "Káº¿t quáº£": ",".join(numbers)}
          df_new = pd.DataFrame([new_row])

          file_path = "data/data_master.csv"
          if not os.path.exists(file_path):
              os.makedirs("data", exist_ok=True)
              df_new.to_csv(file_path, index=False)
              print(f"ğŸ†• Táº¡o má»›i file data_master.csv vá»›i ngÃ y {day}")
          else:
              df_old = pd.read_csv(file_path)
              if str(df_old.iloc[0,0]) == day:
                  print(f"âš ï¸ Dá»¯ liá»‡u {day} Ä‘Ã£ tá»“n táº¡i, bá» qua cáº­p nháº­t.")
              else:
                  df_final = pd.concat([df_new, df_old], ignore_index=True)
                  df_final.to_csv(file_path, index=False)
                  print(f"âœ… ÄÃ£ thÃªm dá»¯ liá»‡u má»›i: {day} lÃªn Ä‘áº§u file data_master.csv")

          PY

      - name: ğŸ’¾ Commit and push updates
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/data_master.csv || echo "KhÃ´ng cÃ³ thay Ä‘á»•i nÃ o Ä‘á»ƒ commit"
          git commit -m "Auto update data_master.csv" || echo "KhÃ´ng cÃ³ commit má»›i"
          git push || echo "KhÃ´ng cÃ³ gÃ¬ Ä‘á»ƒ push"
