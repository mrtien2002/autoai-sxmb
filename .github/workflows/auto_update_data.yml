name: Auto Update Data Master (XSMB)

on:
  schedule:
    - cron: "30 11 * * *"   # cháº¡y 18h30 giá» Viá»‡t Nam
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install requests pandas beautifulsoup4 lxml

      - name: ğŸ”„ Fetch latest XSMB result and prepend to data_master.csv
        run: |
          python <<'PY'
          import pandas as pd, requests, re, os
          from bs4 import BeautifulSoup
          from datetime import datetime

          url = "https://ketqua.net/xo-so-mien-bac"
          html = requests.get(url, timeout=20).text
          soup = BeautifulSoup(html, "lxml")

          # ---- Láº¥y ngÃ y quay an toÃ n ----
          title_tag = soup.select_one("h2.title-xsmb") or soup.find("h2")
          if title_tag:
              title = title_tag.get_text(strip=True)
              m = re.search(r"(\d{1,2}/\d{1,2}/\d{4})", title)
              if m:
                  day = m.group(1)
              else:
                  day = datetime.now().strftime("%d/%m/%Y")
          else:
              day = datetime.now().strftime("%d/%m/%Y")
              print(f"âš ï¸ KhÃ´ng tÃ¬m tháº¥y tiÃªu Ä‘á» ngÃ y, dÃ¹ng ngÃ y há»‡ thá»‘ng {day}")

          # ---- Láº¥y danh sÃ¡ch sá»‘ ----
          numbers = [x.get_text(strip=True)[-2:] for x in soup.select("table.bkqmienbac td span") if x.get_text(strip=True)]
          if not numbers:
              raise Exception("âŒ KhÃ´ng thá»ƒ láº¥y dá»¯ liá»‡u sá»‘ XSMB tá»« trang ketqua.net")

          new_row = {"NgÃ y": day, "Káº¿t quáº£": ",".join(numbers)}
          df_new = pd.DataFrame([new_row])

          file_path = "data/data_master.csv"
          os.makedirs("data", exist_ok=True)
          if not os.path.exists(file_path):
              df_new.to_csv(file_path, index=False)
              print(f"ğŸ†• Táº¡o má»›i file data_master.csv vá»›i ngÃ y {day}")
          else:
              df_old = pd.read_csv(file_path)
              if str(df_old.iloc[0,0]) == day:
                  print(f"âš ï¸ Dá»¯ liá»‡u {day} Ä‘Ã£ tá»“n táº¡i, bá» qua cáº­p nháº­t.")
              else:
                  df_final = pd.concat([df_new, df_old], ignore_index=True)
                  df_final.to_csv(file_path, index=False)
                  print(f"âœ… ÄÃ£ thÃªm dá»¯ liá»‡u má»›i: {day} lÃªn Ä‘áº§u file data_master.csv")
          PY

      - name: ğŸ’¾ Commit and push updates
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/data_master.csv || echo "KhÃ´ng cÃ³ thay Ä‘á»•i nÃ o Ä‘á»ƒ commit"
          git commit -m "Auto update data_master.csv" || echo "KhÃ´ng cÃ³ commit má»›i"
          git push || echo "KhÃ´ng cÃ³ gÃ¬ Ä‘á»ƒ push"
